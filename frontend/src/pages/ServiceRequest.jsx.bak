import { Card, Form, Input, DatePicker, Button, Select, Typography, message } from 'antd'
import api from '../utils/api.js'
import useAuth from '../hooks/useAuth.js'

const { Title, Paragraph } = Typography

const categories = [
  'Plomería',
  'Electricidad',
  'Carpintería',
  'Albañilería',
  'Pintura',
]

const formatAddress = (address) => [
  address.street,
  address.city,
  address.state,
  address.zipCode,
].filter(Boolean).join(', ')

const ServiceRequest = () => {
  const [form] = Form.useForm()
  const { user } = useAuth()
  const savedAddresses = user?.clientProfile?.addresses ?? []

  const handleAddressPrefill = (value) => {
    const selected = savedAddresses.find((address) => {
      const identifier = address.label ?? `${address.street}-${address.city}`
      return identifier === value
    })
    if (selected) {
      form.setFieldsValue({ address: formatAddress(selected) })
    }
  }

  const handleSubmit = async (values) => {
    try {
      const { savedAddress, scheduledAt, ...rest } = values
      const payload = {
        ...rest,
        scheduledAt: scheduledAt?.toISOString(),
      }
      await api.post('/service-request', payload)
      message.success('Solicitud enviada correctamente')
      form.resetFields()
    } catch (error) {
      console.error('service request error', error)
      message.error('No se pudo crear la solicitud, intenta más tarde')
    }
  }

  return (
    <Card>
      <Title level={3}>Crear solicitud de servicio</Title>
      <Paragraph type="secondary">
        Describe el problema o proyecto. Notificaremos a técnicos disponibles en tu zona.
      </Paragraph>
      <Form
        layout="vertical"
        form={form}
        onFinish={handleSubmit}
        initialValues={{
          contactName: user?.profile?.fullName,
        }}
      >
        <Form.Item
          label="Título"
          name="title"
          rules={[{ required: true, message: 'Describe brevemente la solicitud' }]}
        >
          <Input placeholder="Ej. Reparación de fuga bajo lavabo" />
        </Form.Item>
        <Form.Item
          label="Categoría"
          name="category"
          rules={[{ required: true, message: 'Selecciona una categoría' }]}
        >
          <Select placeholder="Selecciona" options={categories.map((value) => ({ value, label: value }))} />
        </Form.Item>
        {savedAddresses.length > 0 && (
          <Form.Item label="Dirección guardada" name="savedAddress">
            <Select
              placeholder="Selecciona una dirección"
              allowClear
              options={savedAddresses.map((address) => ({
                label: address.label ?? formatAddress(address),
                value: address.label ?? `${address.street}-${address.city}`,
              }))}
              onChange={handleAddressPrefill}
            />
          </Form.Item>
        )}
        <Form.Item
          label="Descripción"
          name="description"
          rules={[{ required: true, message: 'Detalla tu solicitud' }]}
        >
          <Input.TextArea rows={4} placeholder="Agrega detalles, accesos, materiales o síntomas." />
        </Form.Item>
        <Form.Item
          label="Dirección"
          name="address"
          rules={[{ required: true, message: 'Indica la dirección del servicio' }]}
        >
          <Input placeholder="Colonia, calle y referencias" />
        </Form.Item>
        <Form.Item
          label="Fecha tentativa"
          name="scheduledAt"
          rules={[{ required: true, message: 'Selecciona una fecha tentativa' }]}
        >
          <DatePicker style={{ width: '100%' }} format="DD/MM/YYYY" />
        </Form.Item>
        <Form.Item
          label="Nombre de contacto"
          name="contactName"
          rules={[{ required: true, message: 'Ingresa un nombre' }]}
        >
          <Input />
        </Form.Item>
        <Form.Item>
          <Button type="primary" htmlType="submit">
            Enviar solicitud
          </Button>
        </Form.Item>
      </Form>
    </Card>
  )
}

export default ServiceRequest

